
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Seasonal Forecast Anomalies &#8212; C3S Training</title>
    
  <link href="_static/css/theme.css" rel="stylesheet">
  <link href="_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="_static/sphinx-book-theme.d59cb220de22ca1c485ebbdc042f0030.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="Analysis of Projected versus Historical Climatology with CORDEX Data" href="05_Climate_Projections_CORDEX.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="_static/C3S–POS–LINE.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">C3S Training</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="intro.html">
   Copernicus Climate Change Service (C3S) Data Tutorials
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Climate Data Store (CDS)
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="00_Climate_Data_Store.html">
   CDS tutorial
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Reanalysis Tutorials
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="01_Climatology.html">
   Climatology
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="02_Climate_Indices.html">
   Climate Indices
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="03_Heatwave_Analysis.html">
   Heatwave Analysis
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Tutorials on Climate Projections
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="04_Climate_Projections_CMIP6.html">
   Climate Projections (CMIP6)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="05_Climate_Projections_CORDEX.html">
   Climate Projections (CORDEX)
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Tutorials on Seasonal Forecasts
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Seasonal Forecast Anomalies
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Atmosphere Monitoring Tutorials
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference external" href="https://ecmwf-projects.github.io/copernicus-training-cams/">
   Tutorials from the Copernicus Atmosphere Monitoring Service (CAMS)
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="_sources/06_Seasonal_Forecast_Anomalies.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
                onclick="printPdf(this)" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/ecmwf-projects/copernicus-training-c3s"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/ecmwf-projects/copernicus-training-c3s/issues/new?title=Issue%20on%20page%20%2F06_Seasonal_Forecast_Anomalies.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/ecmwf-projects/copernicus-training-c3s/main?urlpath=tree/06_Seasonal_Forecast_Anomalies.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show noprint">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#about">
   About
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#install-packages">
   Install packages
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#load-packages">
   Load packages
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#request-data-from-the-cds-programmatically-with-the-cds-api">
   1. Request data from the CDS programmatically with the CDS API
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#calculate-seasonal-hindcast-climate-mean">
   2. Calculate seasonal hindcast climate mean
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#read-the-downloaded-data">
     Read the downloaded data
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#change-representation-of-forecast-lead-time">
     Change representation of forecast lead time
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#extract-data-array-from-dataset">
     Extract data array from dataset
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#average-over-ensemble-members-and-years-to-create-hindcast-climatology">
     Average over ensemble members and years to create hindcast climatology
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#load-monthly-seasonal-forecast-data-for-2021-and-calculate-seasonal-forecast-anomalies">
   3. Load monthly seasonal forecast data for 2021 and calculate seasonal forecast anomalies
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#load-seasonal-forecast-data-for-2021-and-change-representation-of-forecast-lead-time">
     Load seasonal forecast data for 2021 and change representation of forecast lead time
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#calculate-2021-anomalies">
     Calculate 2021 anomalies
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#convert-forecast-lead-time-month-into-dates">
     Convert forecast lead time month into dates
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#convert-from-precipitation-rates-to-accumulation">
     Convert from precipitation rates to accumulation
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#visualize-seasonal-forecast-anomalies-for-a-geographical-subregion">
   4. Visualize seasonal forecast anomalies for a geographical subregion
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#define-a-geographical-subset">
     Define a geographical subset
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#spatial-map-visualization">
     4.1 Spatial map visualization
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#plot-of-total-precipitation-anomalies-for-each-seasonal-forecast-month">
     4.2 Plot of total precipitation anomalies for each seasonal forecast month
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#average-over-region">
       Average over region
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#conversion-of-data-into-two-dimensional-pivot-table">
       Conversion of data into two dimensional pivot table
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#repeat-steps-for-hindcast-data-to-compare-forecast-and-hindcast-anomalies">
       Repeat steps for hindcast data (to compare forecast and hindcast anomalies)
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#calculation-of-hindcast-anomaly-terciles">
       Calculation of hindcast anomaly terciles
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#calculate-seasonal-forecast-3-month-anomalies">
   5. Calculate seasonal forecast 3-month anomalies
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#compute-3-month-rolling-averages">
     Compute 3-month rolling averages
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#calculate-anomalies">
     Calculate anomalies
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#ensemble-mean-anomaly">
     Ensemble mean anomaly
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#convert-precipitation-rate-to-accumulation-in-mm">
     Convert precipitation rate to accumulation in mm
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#visualise-3-monthly-total-precipitation-ensemble-mean-anomalies">
     Visualise 3-monthly total precipitation ensemble mean anomalies
    </a>
   </li>
  </ul>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Seasonal Forecast Anomalies</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#about">
   About
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#install-packages">
   Install packages
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#load-packages">
   Load packages
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#request-data-from-the-cds-programmatically-with-the-cds-api">
   1. Request data from the CDS programmatically with the CDS API
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#calculate-seasonal-hindcast-climate-mean">
   2. Calculate seasonal hindcast climate mean
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#read-the-downloaded-data">
     Read the downloaded data
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#change-representation-of-forecast-lead-time">
     Change representation of forecast lead time
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#extract-data-array-from-dataset">
     Extract data array from dataset
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#average-over-ensemble-members-and-years-to-create-hindcast-climatology">
     Average over ensemble members and years to create hindcast climatology
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#load-monthly-seasonal-forecast-data-for-2021-and-calculate-seasonal-forecast-anomalies">
   3. Load monthly seasonal forecast data for 2021 and calculate seasonal forecast anomalies
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#load-seasonal-forecast-data-for-2021-and-change-representation-of-forecast-lead-time">
     Load seasonal forecast data for 2021 and change representation of forecast lead time
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#calculate-2021-anomalies">
     Calculate 2021 anomalies
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#convert-forecast-lead-time-month-into-dates">
     Convert forecast lead time month into dates
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#convert-from-precipitation-rates-to-accumulation">
     Convert from precipitation rates to accumulation
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#visualize-seasonal-forecast-anomalies-for-a-geographical-subregion">
   4. Visualize seasonal forecast anomalies for a geographical subregion
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#define-a-geographical-subset">
     Define a geographical subset
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#spatial-map-visualization">
     4.1 Spatial map visualization
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#plot-of-total-precipitation-anomalies-for-each-seasonal-forecast-month">
     4.2 Plot of total precipitation anomalies for each seasonal forecast month
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#average-over-region">
       Average over region
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#conversion-of-data-into-two-dimensional-pivot-table">
       Conversion of data into two dimensional pivot table
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#repeat-steps-for-hindcast-data-to-compare-forecast-and-hindcast-anomalies">
       Repeat steps for hindcast data (to compare forecast and hindcast anomalies)
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#calculation-of-hindcast-anomaly-terciles">
       Calculation of hindcast anomaly terciles
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#calculate-seasonal-forecast-3-month-anomalies">
   5. Calculate seasonal forecast 3-month anomalies
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#compute-3-month-rolling-averages">
     Compute 3-month rolling averages
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#calculate-anomalies">
     Calculate anomalies
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#ensemble-mean-anomaly">
     Ensemble mean anomaly
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#convert-precipitation-rate-to-accumulation-in-mm">
     Convert precipitation rate to accumulation in mm
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#visualise-3-monthly-total-precipitation-ensemble-mean-anomalies">
     Visualise 3-monthly total precipitation ensemble mean anomalies
    </a>
   </li>
  </ul>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            
              <div>
                
  <p><img alt="logo" src="_images/LogoLine_horizon_C3S.png" /></p>
<br><div class="tex2jax_ignore mathjax_ignore section" id="seasonal-forecast-anomalies">
<h1>Seasonal Forecast Anomalies<a class="headerlink" href="#seasonal-forecast-anomalies" title="Permalink to this headline">¶</a></h1>
<div class="section" id="about">
<h2>About<a class="headerlink" href="#about" title="Permalink to this headline">¶</a></h2>
<p>This notebook provides a practical introduction to calculating seasonal forecast anomalies with data from the Copernicus Climate Change Service (C3S). C3S seasonal forecast products are based on data from several state-of-the-art seasonal prediction systems. In this tutorial we shall focus on the <a class="reference external" href="https://confluence.ecmwf.int/display/CKB/Description+of+SEAS5+C3S+contribution">ECMWF SEAS5 model</a>, which is one of the forecasting systems available through C3S.</p>
<p>The tutorial will demonstrate how to access real-time forecast data of total precipitation, with a forecast start date in May 2021 and 6 monthly lead times (up to October 2021). Hindcast data for the same start date and lead-time months in the reference period 1993 to 2016 will also be downloaded. The tutorial will then show how to extract a subset area over South Asia for both the forecast and hindcast data. The climate mean for the reference period will be computed and this reference mean will be subtracted from the real-time forecast data to derive monthly anomalies. These will be visualised as both spatial maps and time series. Finally, 3-monthly anomalies will be calculated and visualised in an interactive plot, as a demonstration of how to reproduce similar <a class="reference external" href="https://climate.copernicus.eu/charts/c3s_seasonal/">charts available through C3S</a>.</p>
<p>The notebook has the following outline:</p>
<ul class="simple">
<li><p>1 - Download data from the CDS</p></li>
<li><p>2 - Hindcast data processing: calculate the reference climate mean</p></li>
<li><p>3 - Real-time forecasts: calculate seasonal forecast anomalies</p></li>
<li><p>4 - Visualize seasonal forecast monthly anomalies for a geographical subregion</p>
<ul>
<li><p>4.1 - Spatial maps</p></li>
<li><p>4.2 - Time series of regional averages</p></li>
</ul>
</li>
<li><p>5 - Reproduce C3S graphical products: compute 3-month anomalies</p></li>
</ul>
<br><div class="alert alert-block alert-success">
<b>NOTE</b>: <br>
    <a href="https://cds.climate.copernicus.eu/cdsapp#!/dataset/seasonal-postprocessed-single-levels">Precomputed anomalies are also available through the CDS</a>. Note these may be slightly different due to minor differences in the way they are computed (e.g. months of constant length, 30 days)  and also due to GRIB packing discretisation. <a href="https://confluence.ecmwf.int/display/UDOC/Why+are+there+sometimes+small+negative+precipitation+accumulations+-+ecCodes+GRIB+FAQ">See here for more detials.</a></div><p>Please see here the full documentation of the <a class="reference external" href="https://confluence.ecmwf.int/display/CKB/C3S+Seasonal+Forecasts%3A+datasets+documentation">C3S Seasonal Forecast Datasets</a>. This notebook introduces you to the <a class="reference external" href="https://cds.climate.copernicus.eu/cdsapp#%21/dataset/seasonal-monthly-single-levels?tab=overview">seasonal forecast monthly statistics</a> datasets on single levels (as opposed to multiple levels in the atmosphere).</p>
<style>
td, th {
   border: 1px solid white;
   border-collapse: collapse;
}
</style>
<table align="left">
  <tr>
    <th>Run the tutorial via free cloud platforms: </th>
    <th><a href="https://mybinder.org/v2/gh/ecmwf-projects/copernicus-training-c3s/master?labpath=06_Seasonal_Forecast_Anomalies.ipynb">
        <img src = "https://mybinder.org/badge.svg" alt = "Binder"></th>
    <th><a href="https://kaggle.com/kernels/welcome?src=https://github.com/ecmwf-projects/copernicus-training-c3s/blob/master/06_Seasonal_Forecast_Anomalies.ipynb">
        <img src = "https://kaggle.com/static/images/open-in-kaggle.svg" alt = "Kaggle"></th>
    <th><a href="https://colab.research.google.com/github/ecmwf-projects/copernicus-training-c3s/blob/master/06_Seasonal_Forecast_Anomalies.ipynb">
        <img src = "https://colab.research.google.com/assets/colab-badge.svg" alt = "Colab"></th>
  </tr>
</table><hr></div>
<div class="section" id="install-packages">
<h2>Install packages<a class="headerlink" href="#install-packages" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Install CDS API for downloading data from the CDS</span>
<span class="o">!</span>pip install cdsapi
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Install cfgrib to enable us to read GRIB format files</span>
<span class="o">!</span>conda install -c conda-forge cfgrib -y
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="load-packages">
<h2>Load packages<a class="headerlink" href="#load-packages" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Miscellaneous operating system interfaces</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="c1"># CDS API</span>
<span class="kn">import</span> <span class="nn">cdsapi</span>

<span class="c1"># To map GRIB files to NetCDF Common Data Model</span>
<span class="kn">import</span> <span class="nn">cfgrib</span>

<span class="c1"># Libraries for working with multi-dimensional arrays</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="c1"># Libraries for plotting and geospatial data visualisation</span>
<span class="kn">import</span> <span class="nn">matplotlib.path</span> <span class="k">as</span> <span class="nn">mpath</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="kn">import</span> <span class="nn">cartopy.crs</span> <span class="k">as</span> <span class="nn">ccrs</span>
<span class="kn">from</span> <span class="nn">cartopy.mpl.gridliner</span> <span class="kn">import</span> <span class="n">LONGITUDE_FORMATTER</span><span class="p">,</span> <span class="n">LATITUDE_FORMATTER</span>
<span class="kn">import</span> <span class="nn">cartopy.feature</span> <span class="k">as</span> <span class="nn">cfeature</span>

<span class="c1"># To work with data labels in dictionary format</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>

<span class="c1"># Date and time related libraries</span>
<span class="kn">from</span> <span class="nn">dateutil.relativedelta</span> <span class="kn">import</span> <span class="n">relativedelta</span>
<span class="kn">from</span> <span class="nn">calendar</span> <span class="kn">import</span> <span class="n">monthrange</span>
<span class="kn">import</span> <span class="nn">datetime</span>

<span class="c1"># Interactive HTML widgets</span>
<span class="kn">import</span> <span class="nn">ipywidgets</span> <span class="k">as</span> <span class="nn">widgets</span>

<span class="c1"># Disable warnings for data download via API</span>
<span class="kn">import</span> <span class="nn">urllib3</span> 
<span class="n">urllib3</span><span class="o">.</span><span class="n">disable_warnings</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<hr></div>
<div class="section" id="request-data-from-the-cds-programmatically-with-the-cds-api">
<h2>1. Request data from the CDS programmatically with the CDS API<a class="headerlink" href="#request-data-from-the-cds-programmatically-with-the-cds-api" title="Permalink to this headline">¶</a></h2>
<p>The first step is to request data from the Climate Data Store programmatically with the help of the CDS API. Let us make use of the option to manually set the CDS API credentials. First, you have to define two variables: <code class="docutils literal notranslate"><span class="pre">URL</span></code> and <code class="docutils literal notranslate"><span class="pre">KEY</span></code> which build together your CDS API key. Below, you have to replace the <code class="docutils literal notranslate"><span class="pre">#########</span></code> with your personal CDS key. Please find <a class="reference external" href="https://cds.climate.copernicus.eu/api-how-to">here</a> your personal CDS key.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">URL</span> <span class="o">=</span> <span class="s1">&#39;https://cds.climate.copernicus.eu/api/v2&#39;</span>
<span class="n">KEY</span> <span class="o">=</span> <span class="s1">&#39;########################################&#39;</span>
</pre></div>
</div>
</div>
</div>
<p>Here we specify a data directory in which we will download our data and all output files that we will generate:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">DATADIR</span> <span class="o">=</span> <span class="s1">&#39;../input/seasonal&#39;</span>
</pre></div>
</div>
</div>
</div>
<p>The next step is then to request the seasonal forecast monthly statistics data on single levels with the help of the CDS API. Below, we download two separate files of total precipitation for six monthly lead times (start date in May):</p>
<ul class="simple">
<li><p><strong>Retrospective forecasts (Hindcasts) for 1993 to 2016</strong></p></li>
<li><p><strong>Forecasts for 2021</strong></p></li>
</ul>
<p>Seasonal forecast data are disseminated in the GRIB data format. Let us store the data in the main working directory with the names:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">ecmwf_seas5_1993-2016_05_hindcast_monthly_tp.grib</span></code> and</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ecmwf_seas5_2021_05_forecast_monthly_tp.grib</span></code>.</p></li>
</ul>
<p>Running the code block below will download the data from the CDS as specified by the following API keywords:</p>
<blockquote>
<div><p><strong>Format</strong>: <code class="docutils literal notranslate"><span class="pre">Grib</span></code> <br>
<strong>Originating centre</strong>: <code class="docutils literal notranslate"><span class="pre">ECMWF</span></code> <br>
<strong>System</strong>: <code class="docutils literal notranslate"><span class="pre">5</span></code> <em>this refers to SEAS5</em> <br>
<strong>Variable</strong>: <code class="docutils literal notranslate"><span class="pre">Total</span> <span class="pre">precipitation</span></code> <br>
<strong>Product type</strong>: <code class="docutils literal notranslate"><span class="pre">Monthly</span> <span class="pre">mean</span></code> <em>all ensemble members will be retrieved</em> <br>
<strong>Year</strong>: <code class="docutils literal notranslate"><span class="pre">1993</span> <span class="pre">to</span> <span class="pre">2016</span></code> <em>for the hindcast</em> <code class="docutils literal notranslate"><span class="pre">2021</span></code> <em>for the forecast</em> <br>
<strong>Month</strong>: <code class="docutils literal notranslate"><span class="pre">05</span></code> <em>May</em> <br>
<strong>Leadtime month</strong>: <code class="docutils literal notranslate"><span class="pre">1</span> <span class="pre">to</span> <span class="pre">6</span></code> <em>May to October</em></p>
</div></blockquote>
<p>If you have not already done so, you will need to accept the <strong>terms &amp; conditions</strong> of the data before you can download it. These can be viewed and accepted in the <a class="reference external" href="https://cds.climate.copernicus.eu/cdsapp#%21/dataset/seasonal-monthly-single-levels?tab=form">CDS download page</a> by scrolling to the end of the download form.</p>
<div class="alert alert-block alert-success">
<b>NOTE</b>: <br>
    The API request below can be generated automatically from the <a href="https://cds.climate.copernicus.eu/cdsapp#!/dataset/seasonal-monthly-single-levels?tab=form">CDS download page</a>. At the end of the download form there is a <code>Show API request</code> icon, which allows a copy-paste of the code below.</div><div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">c</span> <span class="o">=</span> <span class="n">cdsapi</span><span class="o">.</span><span class="n">Client</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">URL</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">KEY</span><span class="p">)</span>

<span class="c1"># Hindcast data request</span>
<span class="n">c</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span>
    <span class="s1">&#39;seasonal-monthly-single-levels&#39;</span><span class="p">,</span>
    <span class="p">{</span>
        <span class="s1">&#39;format&#39;</span><span class="p">:</span> <span class="s1">&#39;grib&#39;</span><span class="p">,</span>
        <span class="s1">&#39;originating_centre&#39;</span><span class="p">:</span> <span class="s1">&#39;ecmwf&#39;</span><span class="p">,</span>
        <span class="s1">&#39;system&#39;</span><span class="p">:</span> <span class="s1">&#39;5&#39;</span><span class="p">,</span>
        <span class="s1">&#39;variable&#39;</span><span class="p">:</span> <span class="s1">&#39;total_precipitation&#39;</span><span class="p">,</span>
        <span class="s1">&#39;product_type&#39;</span><span class="p">:</span> <span class="s1">&#39;monthly_mean&#39;</span><span class="p">,</span>
        <span class="s1">&#39;year&#39;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s1">&#39;1993&#39;</span><span class="p">,</span> <span class="s1">&#39;1994&#39;</span><span class="p">,</span> <span class="s1">&#39;1995&#39;</span><span class="p">,</span>
            <span class="s1">&#39;1996&#39;</span><span class="p">,</span> <span class="s1">&#39;1997&#39;</span><span class="p">,</span> <span class="s1">&#39;1998&#39;</span><span class="p">,</span>
            <span class="s1">&#39;1999&#39;</span><span class="p">,</span> <span class="s1">&#39;2000&#39;</span><span class="p">,</span> <span class="s1">&#39;2001&#39;</span><span class="p">,</span>
            <span class="s1">&#39;2002&#39;</span><span class="p">,</span> <span class="s1">&#39;2003&#39;</span><span class="p">,</span> <span class="s1">&#39;2004&#39;</span><span class="p">,</span>
            <span class="s1">&#39;2005&#39;</span><span class="p">,</span> <span class="s1">&#39;2006&#39;</span><span class="p">,</span> <span class="s1">&#39;2007&#39;</span><span class="p">,</span>
            <span class="s1">&#39;2008&#39;</span><span class="p">,</span> <span class="s1">&#39;2009&#39;</span><span class="p">,</span> <span class="s1">&#39;2010&#39;</span><span class="p">,</span>
            <span class="s1">&#39;2011&#39;</span><span class="p">,</span> <span class="s1">&#39;2012&#39;</span><span class="p">,</span> <span class="s1">&#39;2013&#39;</span><span class="p">,</span>
            <span class="s1">&#39;2014&#39;</span><span class="p">,</span> <span class="s1">&#39;2015&#39;</span><span class="p">,</span> <span class="s1">&#39;2016&#39;</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="s1">&#39;month&#39;</span><span class="p">:</span> <span class="s1">&#39;05&#39;</span><span class="p">,</span>
        <span class="s1">&#39;leadtime_month&#39;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="s1">&#39;3&#39;</span><span class="p">,</span>
            <span class="s1">&#39;4&#39;</span><span class="p">,</span> <span class="s1">&#39;5&#39;</span><span class="p">,</span> <span class="s1">&#39;6&#39;</span><span class="p">,</span>
        <span class="p">],</span>
    <span class="p">},</span>
    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">DATADIR</span><span class="si">}</span><span class="s1">/ecmwf_seas5_1993-2016_05_hindcast_monthly_tp.grib&#39;</span><span class="p">)</span>

<span class="c1"># Forecast data request</span>
<span class="n">c</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span>
    <span class="s1">&#39;seasonal-monthly-single-levels&#39;</span><span class="p">,</span>
    <span class="p">{</span>
        <span class="s1">&#39;format&#39;</span><span class="p">:</span> <span class="s1">&#39;grib&#39;</span><span class="p">,</span>
        <span class="s1">&#39;originating_centre&#39;</span><span class="p">:</span> <span class="s1">&#39;ecmwf&#39;</span><span class="p">,</span>
        <span class="s1">&#39;system&#39;</span><span class="p">:</span> <span class="s1">&#39;5&#39;</span><span class="p">,</span>
        <span class="s1">&#39;variable&#39;</span><span class="p">:</span> <span class="s1">&#39;total_precipitation&#39;</span><span class="p">,</span>
        <span class="s1">&#39;product_type&#39;</span><span class="p">:</span> <span class="s1">&#39;monthly_mean&#39;</span><span class="p">,</span>
        <span class="s1">&#39;year&#39;</span><span class="p">:</span> <span class="s1">&#39;2021&#39;</span><span class="p">,</span>
        <span class="s1">&#39;month&#39;</span><span class="p">:</span> <span class="s1">&#39;05&#39;</span><span class="p">,</span>
        <span class="s1">&#39;leadtime_month&#39;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="s1">&#39;3&#39;</span><span class="p">,</span>
            <span class="s1">&#39;4&#39;</span><span class="p">,</span> <span class="s1">&#39;5&#39;</span><span class="p">,</span> <span class="s1">&#39;6&#39;</span><span class="p">,</span>
        <span class="p">],</span>
    <span class="p">},</span>
    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">DATADIR</span><span class="si">}</span><span class="s1">/ecmwf_seas5_2021_05_forecast_monthly_tp.grib&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<br></div>
<div class="section" id="calculate-seasonal-hindcast-climate-mean">
<h2>2. Calculate seasonal hindcast climate mean<a class="headerlink" href="#calculate-seasonal-hindcast-climate-mean" title="Permalink to this headline">¶</a></h2>
<p>Seasonal forecasts are affected by systematic errors (biases) which are dependent on the leadtime, the time of year, the variable and the location. Hindcast data can help us to understand and account for these biases. We will calculate the hindcast climate mean for each lead time month, averaged over the years 1993 to 2016. In the next section we will then calculate the anomalies, i.e. the deviation of the 2021 forecast for each lead time month with respect to the hindcast mean. Anomalies are thus calculated “in the model space” where the model climate calculated from the hindcasts is taken as the reference.</p>
<div class="section" id="read-the-downloaded-data">
<h3>Read the downloaded data<a class="headerlink" href="#read-the-downloaded-data" title="Permalink to this headline">¶</a></h3>
<p>We will use the Python library <a class="reference external" href="http://xarray.pydata.org/en/stable/">xarray</a> and its function <code class="docutils literal notranslate"><span class="pre">open_dataset</span></code> to read the GRIB file of the hindcast data, specifying the keyword argument <code class="docutils literal notranslate"><span class="pre">engine</span></code> and <code class="docutils literal notranslate"><span class="pre">'cfgrib'</span></code>. <a class="reference external" href="https://github.com/ecmwf/cfgrib">cfgrib</a> is a Python interface to map GRIB files to the NetCDF Common Data Model using <a class="reference external" href="https://github.com/ecmwf/eccodes">ecCodes</a>.</p>
<p>The result is a <code class="docutils literal notranslate"><span class="pre">xarray.Dataset</span></code> object with five dimensions:</p>
<blockquote>
<div><p><strong>Number</strong>: Ensemble members (25) <br>
<strong>Time</strong>: Forecast start date for each year (1st of May) <br>
<strong>Step</strong>: Lead time (nanoseconds in each leadtime month) <br>
<strong>Latitude</strong>: Latitudes in 1 deg resolution<br>
<strong>Longitude</strong>: Longitudes in 1 deg resolution and in 0-360 grid<br></p>
</div></blockquote>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">DATADIR</span><span class="si">}</span><span class="s1">/ecmwf_seas5_1993-2016_05_hindcast_monthly_tp.grib&#39;</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;cfgrib&#39;</span><span class="p">)</span>
<span class="n">ds</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="change-representation-of-forecast-lead-time">
<h3>Change representation of forecast lead time<a class="headerlink" href="#change-representation-of-forecast-lead-time" title="Permalink to this headline">¶</a></h3>
<p>Notice that xarray attempts to extract the time dimensions from the metadata in the GRIB file. By default, it tries to arrange the shape of the data array using “time” (the start time) and “step” (the lead-time in nanoseconds). This comes with two potential issues:</p>
<ul class="simple">
<li><p>Due to some limitations in the GRIB edition 1 encoding of long forecasts, monthly aggregations such as these do not perfectly encode the start and end of the aggregation period (calendar months), and instead they use “step”, which points to the end of the aggregating interval. This might be misleading.</p></li>
<li><p>Due to the different lengths of February in leap and non/leap years, we might have different values of “step” for the same “leadtime_month” index when we put together different start years, as we do here.</p></li>
</ul>
<p>A more useful representation of the data is to replace the dimension “step” with “forecastMonth”, which is part of the GRIB metadata and provides the same integer indices used in the CDS API syntax for “leadtime_month”, with the value 1 corresponding to the first complete calendar month after the forecast start date. For instance for a forecast with start date on the 1st May, <code class="docutils literal notranslate"><span class="pre">forecastMonth=1</span></code> is May, and for a forecast with start date on 17th April, <code class="docutils literal notranslate"><span class="pre">forecastMonth=1</span></code> would also be May. This is more coherent and avoids the ambiguity described above.</p>
<p>We will create this custom data structure through use of the  keyword argument <code class="docutils literal notranslate"><span class="pre">backend_kwargs</span></code> with the <code class="docutils literal notranslate"><span class="pre">time_dims</span></code> option, specifying the two time dimensions: <code class="docutils literal notranslate"><span class="pre">forecastMonth</span></code> and <code class="docutils literal notranslate"><span class="pre">time</span></code> (or <code class="docutils literal notranslate"><span class="pre">indexing_time</span></code>, see note below). The new dataset will then have <code class="docutils literal notranslate"><span class="pre">forecastMonth</span></code> instead of <code class="docutils literal notranslate"><span class="pre">step</span></code>, with values from 1 to 6 (for each lead time month). In this conversion we will lose some information about <code class="docutils literal notranslate"><span class="pre">valid_time</span></code>, which we will need to calculate later.</p>
<div class="alert alert-block alert-success">
<b>NOTE</b>: <br>
    The second of the time dimensions is valid for systems with burst start dates (such as in our example), but for lagged systems, <i>time</i> should be replaced with <i>indexing_time</i>. Please see <a href="https://confluence.ecmwf.int/display/CKB/Seasonal+forecasts+and+the+Copernicus+Climate+Change+Service#heading-Burstvslaggedmode">here</a> for more details on the difference between burst and lagged systems.</div><div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ds_hindcast</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">DATADIR</span><span class="si">}</span><span class="s1">/ecmwf_seas5_1993-2016_05_hindcast_monthly_tp.grib&#39;</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;cfgrib&#39;</span><span class="p">,</span> <span class="n">backend_kwargs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">time_dims</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;forecastMonth&#39;</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">)))</span>
<span class="n">ds_hindcast</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="extract-data-array-from-dataset">
<h3>Extract data array from dataset<a class="headerlink" href="#extract-data-array-from-dataset" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">xarray.Dataset</span></code> object into which we have read the data from the downloaded GRIB files may contain arrays of multiple variables (even if we have only one: total precipitation). Another xarray data structure, <code class="docutils literal notranslate"><span class="pre">xarray.DataArray</span></code>, facilitates operations on single variables. We will use this to further process our data. You can select the relevant DataArray from a Dataset by specifying the name of the variable (in our case <code class="docutils literal notranslate"><span class="pre">tprate</span></code>) in square brackets <code class="docutils literal notranslate"><span class="pre">[]</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tprate_hindcast</span> <span class="o">=</span> <span class="n">ds_hindcast</span><span class="p">[</span><span class="s1">&#39;tprate&#39;</span><span class="p">]</span>
<span class="n">tprate_hindcast</span>
</pre></div>
</div>
</div>
</div>
<p>A DataArray provides additional attributes of the variable. For example, you see that the precipitation is expressed as a rate with the unit m/s. Some variables (like precipitation, radiation or heat fluxes) are encoded in GRIB as accumulations from the beginning of the forecast, and their monthly aggregations are therefore expressed as rates. Later in this tutorial we shall convert this to total accumulation.</p>
</div>
<div class="section" id="average-over-ensemble-members-and-years-to-create-hindcast-climatology">
<h3>Average over ensemble members and years to create hindcast climatology<a class="headerlink" href="#average-over-ensemble-members-and-years-to-create-hindcast-climatology" title="Permalink to this headline">¶</a></h3>
<p>We can now create the hindcast climatology by averaging over the 25 ensemble members and the 24 years. We do this for each forecast lead time and for each geographical grid point. We use the function <code class="docutils literal notranslate"><span class="pre">mean()</span></code> to average over one or more dimensions, which in this case are <code class="docutils literal notranslate"><span class="pre">number</span></code> (25 ensemble members) and <code class="docutils literal notranslate"><span class="pre">time</span></code> (years from 1993 to 2016). The result is an <code class="docutils literal notranslate"><span class="pre">xarray.DataArray</span></code> with three dimensions: <code class="docutils literal notranslate"><span class="pre">forecastMonth</span></code>, <code class="docutils literal notranslate"><span class="pre">latitude</span></code> and <code class="docutils literal notranslate"><span class="pre">longitude</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tprate_hindcast_mean</span> <span class="o">=</span> <span class="n">tprate_hindcast</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="s1">&#39;number&#39;</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">])</span>
<span class="n">tprate_hindcast_mean</span>
</pre></div>
</div>
</div>
</div>
<br></div>
</div>
<div class="section" id="load-monthly-seasonal-forecast-data-for-2021-and-calculate-seasonal-forecast-anomalies">
<h2>3. Load monthly seasonal forecast data for 2021 and calculate seasonal forecast anomalies<a class="headerlink" href="#load-monthly-seasonal-forecast-data-for-2021-and-calculate-seasonal-forecast-anomalies" title="Permalink to this headline">¶</a></h2>
<p>The next step is to load the real-time seasonal forecast data for 6 lead time months in 2021, beginning in May. We will then subtract the hindcast climatology from this to derive the anomalies.</p>
<div class="section" id="load-seasonal-forecast-data-for-2021-and-change-representation-of-forecast-lead-time">
<h3>Load seasonal forecast data for 2021 and change representation of forecast lead time<a class="headerlink" href="#load-seasonal-forecast-data-for-2021-and-change-representation-of-forecast-lead-time" title="Permalink to this headline">¶</a></h3>
<p>Before we can subtract the hindcast anomaly from the 2021 forecast, we need first to ensure the two datasets have the same structure. We thus need to apply the same processing on the forecast data as we did with the hindcast to use <code class="docutils literal notranslate"><span class="pre">forecastMonth</span></code> as a coordinate of the array instead of <code class="docutils literal notranslate"><span class="pre">step</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">seas5_forecast</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">DATADIR</span><span class="si">}</span><span class="s1">/ecmwf_seas5_2021_05_forecast_monthly_tp.grib&#39;</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;cfgrib&#39;</span><span class="p">,</span> 
                                 <span class="n">backend_kwargs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">time_dims</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;forecastMonth&#39;</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">)))</span>
<span class="n">seas5_forecast</span>
</pre></div>
</div>
</div>
</div>
<p>Once the <code class="docutils literal notranslate"><span class="pre">xarray.Dataset</span></code> is loaded, you see that it has 4 dimensions:</p>
<blockquote>
<div><p><strong>Number</strong>: 51 ensemble members <br>
<strong>ForecastMonth</strong>: 6 leadtime months <br>
<strong>Latitude</strong>: latitude values <br>
<strong>Longitude</strong>: longitude values <br></p>
</div></blockquote>
<p>Compared to the hindcast data, we have only a single start date (May 2021) in the <code class="docutils literal notranslate"><span class="pre">time</span></code> coordinate. Another difference is that seasonal forecast real-time data have 51 ensemble members, compared to hindcasts, which only have 25 ensemble members.</p>
</div>
<div class="section" id="calculate-2021-anomalies">
<h3>Calculate 2021 anomalies<a class="headerlink" href="#calculate-2021-anomalies" title="Permalink to this headline">¶</a></h3>
<p>Now, we can compute the seasonal forecast anomalies for the 6 lead time months beginning with May 2021. We can compute the anomalies by subtracting the long term average (<code class="docutils literal notranslate"><span class="pre">tprate_hindcast_mean</span></code>) from the seasonal forecast real-time data for May 2021 (<code class="docutils literal notranslate"><span class="pre">seas5_forecast</span></code>).</p>
<p>The resulting <code class="docutils literal notranslate"><span class="pre">xarray.DataArray</span></code> has the anomaly information for each of the lead time months from May 2021 to October 2021 relative to the reference period May to October for the years 1993 to 2016.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">seas5_anomalies_202105</span> <span class="o">=</span> <span class="n">seas5_forecast</span><span class="p">[</span><span class="s1">&#39;tprate&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">tprate_hindcast_mean</span>
<span class="n">seas5_anomalies_202105</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="convert-forecast-lead-time-month-into-dates">
<h3>Convert forecast lead time month into dates<a class="headerlink" href="#convert-forecast-lead-time-month-into-dates" title="Permalink to this headline">¶</a></h3>
<p>A closer look at the coordinate information of <code class="docutils literal notranslate"><span class="pre">forecastMonth</span></code> reveals that it only gives integer values from 1 to 6, but not the actual time for which the forecast is valid. We will need this latter information when we convert from precipitation rate to accumulation, as for this we will need to know the number of days per month. Additionally, this information will be useful for later labelling.</p>
<p>To calculate the time for which the forecast is valid, let us assign a new coordinate with the name <code class="docutils literal notranslate"><span class="pre">valid_time</span></code> based on the dimension <code class="docutils literal notranslate"><span class="pre">forecastMonth</span></code>. This coordinate information shall provide us the valid timestamp for each of the forecast months. We can use the value of the time dimension as the start date. The function <code class="docutils literal notranslate"><span class="pre">relativedelta()</span></code> allows us to add a specific number of months to the start date.</p>
<p>In a second step, with the xarray function <code class="docutils literal notranslate"><span class="pre">assign_coords()</span></code>, we assign this newly created <code class="docutils literal notranslate"><span class="pre">DateTimeIndex</span></code> object as a new coordinate.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">valid_time</span> <span class="o">=</span> <span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">seas5_anomalies_202105</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">+</span> <span class="n">relativedelta</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="n">fcmonth</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">fcmonth</span> <span class="ow">in</span> <span class="n">seas5_anomalies_202105</span><span class="o">.</span><span class="n">forecastMonth</span><span class="p">]</span>
<span class="n">seas5_anomalies_202105</span> <span class="o">=</span> <span class="n">seas5_anomalies_202105</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">valid_time</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;forecastMonth&#39;</span><span class="p">,</span><span class="n">valid_time</span><span class="p">))</span>
<span class="n">seas5_anomalies_202105</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="convert-from-precipitation-rates-to-accumulation">
<h3>Convert from precipitation rates to accumulation<a class="headerlink" href="#convert-from-precipitation-rates-to-accumulation" title="Permalink to this headline">¶</a></h3>
<p>Before visualizing the seasonal forecast anomalies, let us convert the precipitation from rates in m/s to total accumulated precipitation per month in mm. The conversion has to be done per month, as it is dependent on the number of days of a specific month. For this, we create a new dimension called <code class="docutils literal notranslate"><span class="pre">numdays</span></code>. The function <code class="docutils literal notranslate"><span class="pre">monthrange()</span></code> from the calendar library returns the number of days in a month, based on a given year and month. With the help of the new coordinate information <code class="docutils literal notranslate"><span class="pre">valid_time</span></code>, we can thus create a list of the number of days. Again, with the function <code class="docutils literal notranslate"><span class="pre">assign_coords()</span></code>, we assign this list as a new coordinate in our data array.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">numdays</span> <span class="o">=</span> <span class="p">[</span><span class="n">monthrange</span><span class="p">(</span><span class="n">dd</span><span class="o">.</span><span class="n">year</span><span class="p">,</span><span class="n">dd</span><span class="o">.</span><span class="n">month</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="n">valid_time</span><span class="p">]</span>
<span class="n">seas5_anomalies_202105</span> <span class="o">=</span> <span class="n">seas5_anomalies_202105</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">numdays</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;forecastMonth&#39;</span><span class="p">,</span><span class="n">numdays</span><span class="p">))</span>
<span class="n">seas5_anomalies_202105</span>
</pre></div>
</div>
</div>
</div>
<p>We can now use the newly created coordinate information to convert for each month the precipitation accumulations to total precipitation. For this, we multiply the precipitation values with the number of days and then with 24 x 60 x 60 (number of seconds in a day) to retrieve precipitation values in m. As a last step, we convert the values in m to mm by multiplying them by 1000.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">seas5_anomalies_202105_tp</span> <span class="o">=</span> <span class="n">seas5_anomalies_202105</span> <span class="o">*</span> <span class="n">seas5_anomalies_202105</span><span class="o">.</span><span class="n">numdays</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">1000</span>
<span class="n">seas5_anomalies_202105_tp</span>
</pre></div>
</div>
</div>
</div>
<p>As a last step before visualizing the data, we want to add the attributes units and long_name and update them, as they have changed with the previous workflow steps. You can simply specify the name of an attribute (e.g. units ) and assign it a new value.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">seas5_anomalies_202105_tp</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;mm&#39;</span>
<span class="n">seas5_anomalies_202105_tp</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Total precipitation anomaly&#39;</span> 
<span class="n">seas5_anomalies_202105_tp</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="visualize-seasonal-forecast-anomalies-for-a-geographical-subregion">
<h2>4. Visualize seasonal forecast anomalies for a geographical subregion<a class="headerlink" href="#visualize-seasonal-forecast-anomalies-for-a-geographical-subregion" title="Permalink to this headline">¶</a></h2>
<p>To visualise the seasonal forecast anomalies, we could simply look at the ensemble mean to summarise the information given by all individual ensemble members. However, this would mean we lose the richness of information the whole ensemble provides. To highlight the relevance of considering not only the ensemble mean but the complete distribution, we will plot the anomalies for all individual members. We will do this in two ways:</p>
<blockquote>
<div><ol class="simple">
<li><p><strong>Spatial map</strong> of all individual members for a given lead time. <br></p></li>
<li><p><strong>Time series plot</strong> of all members averaged over a given region. <br></p></li>
</ol>
</div></blockquote>
<p>We will explore these two methods in the respective subsections below, but we will do so for a geographical subset for South Asia with a bounding box of <code class="docutils literal notranslate"><span class="pre">[N:30,</span> <span class="pre">W:70,</span> <span class="pre">S:5,</span> <span class="pre">E:90]</span></code>. The first step is therefore to subset the data over this area.</p>
<div class="section" id="define-a-geographical-subset">
<h3>Define a geographical subset<a class="headerlink" href="#define-a-geographical-subset" title="Permalink to this headline">¶</a></h3>
<p>To create a subset, we will define a function called <code class="docutils literal notranslate"><span class="pre">ds_latlon_subet()</span></code> which generates a geographical subset of an xarray data array. The latitude and longitude values that are outside the defined area are dropped.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">ds_latlon_subset</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="n">area</span><span class="p">,</span><span class="n">latname</span><span class="o">=</span><span class="s1">&#39;latitude&#39;</span><span class="p">,</span><span class="n">lonname</span><span class="o">=</span><span class="s1">&#39;longitude&#39;</span><span class="p">):</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">ds</span><span class="p">[</span><span class="n">latname</span><span class="p">]</span><span class="o">&lt;=</span><span class="n">area</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ds</span><span class="p">[</span><span class="n">latname</span><span class="p">]</span><span class="o">&gt;=</span><span class="n">area</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ds</span><span class="p">[</span><span class="n">lonname</span><span class="p">]</span><span class="o">&lt;=</span><span class="n">area</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">%</span><span class="k">360</span>) &amp; (ds[lonname]&gt;=area[1]%360)
    <span class="n">dsout</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dsout</span>
</pre></div>
</div>
</div>
</div>
<p>Now, we apply the function <code class="docutils literal notranslate"><span class="pre">ds_latlon_subset()</span></code> to the data array of the seasonal forecast anomalies.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sub</span> <span class="o">=</span> <span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">90</span><span class="p">)</span> <span class="c1"># North/West/South/East</span>
<span class="n">seas5_SAsia</span> <span class="o">=</span> <span class="n">ds_latlon_subset</span><span class="p">(</span><span class="n">seas5_anomalies_202105_tp</span><span class="p">,</span> <span class="n">sub</span><span class="p">)</span>
<span class="n">seas5_SAsia</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="spatial-map-visualization">
<h3>4.1 Spatial map visualization<a class="headerlink" href="#spatial-map-visualization" title="Permalink to this headline">¶</a></h3>
<p>Now we can create a spatial map visualisation which shows for a given lead time the total precipitation anomaly of the 51 ensemble members.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Select a leadtime to visualise</span>
<span class="n">lead_time</span> <span class="o">=</span> <span class="mi">2</span>
</pre></div>
</div>
</div>
</div>
<p>The plotting code below can be split into the following sections:</p>
<blockquote>
<div><ol class="simple">
<li><p><strong>Define the overall figure</strong>: Including the size and spacing between subplots. <br></p></li>
<li><p><strong>Create the plots</strong>: Loop over each subplot and set a customized title, add coastlines and set geographical extent. <br></p></li>
<li><p><strong>Create a colour bar</strong>: Add a colour bar with a label. <br></p></li>
<li><p><strong>Save the figure</strong>: Save the figure as a png file. <br></p></li>
</ol>
</div></blockquote>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define figure and spacing between subplots</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span> <span class="n">wspace</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">)</span>

<span class="n">new_date_format</span> <span class="o">=</span> <span class="n">seas5_SAsia</span><span class="p">[</span><span class="s1">&#39;valid_time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%b, %Y&#39;</span><span class="p">)</span>

<span class="c1"># Define overall title</span>
<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;C3S ECMWF SEAS5 total precipitation anomaly&#39;</span>
             <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">linesep</span> <span class="o">+</span> 
             <span class="sa">f</span><span class="s1">&#39;Start data: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">new_date_format</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span> 
             <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39; - Valid date: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">new_date_format</span><span class="p">[</span><span class="n">lead_time</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
             <span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>

<span class="c1"># Define each subplot looping through the ensemble members</span>
<span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">51</span><span class="p">):</span>
    <span class="c1"># Add a new subplot iteratively</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">())</span>
    <span class="c1"># Plot data</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">seas5_SAsia</span><span class="o">.</span><span class="n">longitude</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">seas5_SAsia</span><span class="o">.</span><span class="n">latitude</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> 
                       <span class="n">seas5_SAsia</span><span class="p">[</span><span class="n">n</span><span class="p">,</span><span class="n">lead_time</span><span class="o">-</span><span class="mi">1</span><span class="p">,:,:],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;bwr_r&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="mi">350</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">350</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Member </span><span class="si">{</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span> <span class="c1"># Set subplot title</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">coastlines</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span> <span class="c1"># Add coastlines</span>
    <span class="c1"># Set the extent (x0, x1, y0, y1) of the map in the given coordinate system.</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_extent</span><span class="p">([</span><span class="n">sub</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">sub</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">sub</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">sub</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">crs</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">())</span>

<span class="c1"># Create a colour bar at the bottom of the fugure</span>
<span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">bottom</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
<span class="c1"># Add axis to make space for colour bar (left, bottom, width, height)</span>
<span class="n">cbar_ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">])</span>
<span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cbar_ax</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;horizontal&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Total precipitation anomaly (mm)&#39;</span><span class="p">)</span>

<span class="c1"># Save the figure</span>
<span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;./TotalPrecAnomalyForecastSAsia.png&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<br></div>
<div class="section" id="plot-of-total-precipitation-anomalies-for-each-seasonal-forecast-month">
<h3>4.2 Plot of total precipitation anomalies for each seasonal forecast month<a class="headerlink" href="#plot-of-total-precipitation-anomalies-for-each-seasonal-forecast-month" title="Permalink to this headline">¶</a></h3>
<p>In this step we will summarise the total precipitation behaviour over the whole region for each lead time month. We will do this by averaging in the spatial (latitude and longitude) dimensions.</p>
<p>To put the anomalies in context they will be compared to the reference climate computed in this subregion from the hindcast data.</p>
<div class="section" id="average-over-region">
<h4>Average over region<a class="headerlink" href="#average-over-region" title="Permalink to this headline">¶</a></h4>
<p>The first step is to create the weighted average of the subregion defined above. For this, we first estimate the cell area with the cosine of the latitude. These weights are then applied when the data array is averaged over the two dimensions <code class="docutils literal notranslate"><span class="pre">latitude</span></code> and <code class="docutils literal notranslate"><span class="pre">longitude</span></code>. You can use the xarray function <code class="docutils literal notranslate"><span class="pre">weighted()</span></code> together with the function <code class="docutils literal notranslate"><span class="pre">mean()</span></code> to create a weighted average of the geographical region. The result is a data array with two dimensions: <code class="docutils literal notranslate"><span class="pre">number</span></code> and <code class="docutils literal notranslate"><span class="pre">forecastMonth</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">weights</span> <span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">seas5_SAsia</span><span class="o">.</span><span class="n">latitude</span><span class="p">))</span>

<span class="n">anoms_SAsia</span> <span class="o">=</span> <span class="n">seas5_SAsia</span><span class="o">.</span><span class="n">weighted</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="s1">&#39;latitude&#39;</span><span class="p">,</span><span class="s1">&#39;longitude&#39;</span><span class="p">])</span>
<span class="n">anoms_SAsia</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="conversion-of-data-into-two-dimensional-pivot-table">
<h4>Conversion of data into two dimensional pivot table<a class="headerlink" href="#conversion-of-data-into-two-dimensional-pivot-table" title="Permalink to this headline">¶</a></h4>
<p>To facilitate further processing we will convert the data array into a pandas.Dataframe object with the function <code class="docutils literal notranslate"><span class="pre">to_dataframe()</span></code>. Pandas dataframes are optimised for the processing and visualisation of two dimensional data. We may want to drop coordinates that are not needed. We can do this with the function <code class="docutils literal notranslate"><span class="pre">drop_vars()</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">anoms_SAsia_df</span> <span class="o">=</span> <span class="n">anoms_SAsia</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">([</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;surface&#39;</span><span class="p">,</span><span class="s1">&#39;numdays&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;anomaly&#39;</span><span class="p">)</span>
<span class="n">anoms_SAsia_df</span>
</pre></div>
</div>
</div>
</div>
<p>We will now reorganise the data structure to facilitate plotting. We will do this through the use of the following Pandas functions:</p>
<blockquote>
<div><p><strong>reset_index().drop()</strong>: We use <code class="docutils literal notranslate"><span class="pre">reset_index()</span></code> to convert the ensemble members into columns, and we use <code class="docutils literal notranslate"><span class="pre">drop()</span></code> to remove the <em>forecastMonth</em> column, as we have the same information in the <em>valid_time</em> dimension <br>
<strong>set_index()</strong>: allows us to define which column(s) shall be used as data frame indices <br>
<strong>unstack()</strong>: converts the columns into a pivot table, thus re-arranging the data into an easily manageable two dimensional table.<br></p>
</div></blockquote>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">anoms_SAsia_df</span> <span class="o">=</span> <span class="n">anoms_SAsia_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;forecastMonth&#39;</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;valid_time&#39;</span><span class="p">,</span><span class="s1">&#39;number&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span>
<span class="n">anoms_SAsia_df</span>
</pre></div>
</div>
</div>
</div>
<p>The data frame above provides us for each ensemble member and forecast month the total precipitation anomaly.</p>
<p>As a last step, to improve the labels of our data plot later on, we will convert the <code class="docutils literal notranslate"><span class="pre">valid_time</span></code> column values from <em>YYYY-MM-DD</em> format into <em>Month, Year</em> format.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">anoms_SAsia_m_yr</span> <span class="o">=</span> <span class="n">anoms_SAsia_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">anoms_SAsia_m_yr</span><span class="p">[</span><span class="s1">&#39;valid_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">anoms_SAsia_m_yr</span><span class="p">[</span><span class="s1">&#39;valid_time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%b, %Y&#39;</span><span class="p">)</span>
<span class="n">anoms_SAsia_m_yr</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="repeat-steps-for-hindcast-data-to-compare-forecast-and-hindcast-anomalies">
<h4>Repeat steps for hindcast data (to compare forecast and hindcast anomalies)<a class="headerlink" href="#repeat-steps-for-hindcast-data-to-compare-forecast-and-hindcast-anomalies" title="Permalink to this headline">¶</a></h4>
<p>We would like now to repeat the steps for the hindcast data in order to show the forecast in the context of the reference climate. I.e. we will compare the seasonal forecast and hindcast anomalies for each lead-time month. In the final plot we will show the anomaly of each forecast ensemble member, while the model climate defined by the hindcasts will be represented in the form of tercile categories. This will put each ensemble member forecast anomaly into context and will give us an indication of its intensity.</p>
<p>We therefore revisit the hindcast data (<code class="docutils literal notranslate"><span class="pre">tprate_hindcast</span></code>), which we loaded in <a class="reference external" href="#hindcast_climate_mean">section 2</a> above. We will apply the same steps to create a geographical subset and aggregate spatially.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tprate_hindcast_SAsia</span> <span class="o">=</span> <span class="n">ds_latlon_subset</span><span class="p">(</span><span class="n">tprate_hindcast</span><span class="p">,</span> <span class="n">sub</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>To create the weighted average of the two dimensions <code class="docutils literal notranslate"><span class="pre">latitude</span></code> and <code class="docutils literal notranslate"><span class="pre">longitude</span></code>, we can use the same <code class="docutils literal notranslate"><span class="pre">weights</span></code> as above.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tprate_hindcast_SAsia</span> <span class="o">=</span> <span class="n">tprate_hindcast_SAsia</span><span class="o">.</span><span class="n">weighted</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="s1">&#39;latitude&#39;</span><span class="p">,</span><span class="s1">&#39;longitude&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<p>The resulting array has three remaining dimensions, <code class="docutils literal notranslate"><span class="pre">number</span></code>, <code class="docutils literal notranslate"><span class="pre">forecastMonth</span></code> and <code class="docutils literal notranslate"><span class="pre">time</span></code>.</p>
<p>The next step is to compute the hindcast anomalies using the hindcast climatology as reference. As before, we create the hindcast climatology by computing the mean over the two dimensions <code class="docutils literal notranslate"><span class="pre">number</span></code> (ensemble member) and <code class="docutils literal notranslate"><span class="pre">time</span></code> (years) resulting in the climatology for each lead-time month. We then subtract this from the hindcast data to derive the anomalies.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">anom_hindcast</span> <span class="o">=</span> <span class="n">tprate_hindcast_SAsia</span> <span class="o">-</span> <span class="n">tprate_hindcast_SAsia</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="s1">&#39;number&#39;</span><span class="p">,</span><span class="s1">&#39;time&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<p>We now repeat the same steps to convert precipitation accumulations in m/s to total precipitation in m.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">valid_time</span> <span class="o">=</span> <span class="p">[</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">anom_hindcast</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="n">relativedelta</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="n">fcmonth</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">fcmonth</span> <span class="ow">in</span> <span class="n">anom_hindcast</span><span class="o">.</span><span class="n">forecastMonth</span><span class="p">]</span>
<span class="n">numdays</span> <span class="o">=</span> <span class="p">[</span><span class="n">monthrange</span><span class="p">(</span><span class="n">dd</span><span class="o">.</span><span class="n">year</span><span class="p">,</span><span class="n">dd</span><span class="o">.</span><span class="n">month</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="n">valid_time</span><span class="p">]</span>
<span class="n">anom_hindcast</span> <span class="o">=</span> <span class="n">anom_hindcast</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">numdays</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;forecastMonth&#39;</span><span class="p">,</span><span class="n">numdays</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">anom_hindcast_tp</span> <span class="o">=</span> <span class="n">anom_hindcast</span> <span class="o">*</span> <span class="n">anom_hindcast</span><span class="o">.</span><span class="n">numdays</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">1000</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="calculation-of-hindcast-anomaly-terciles">
<h4>Calculation of hindcast anomaly terciles<a class="headerlink" href="#calculation-of-hindcast-anomaly-terciles" title="Permalink to this headline">¶</a></h4>
<p>Now, for each of the lead-time months, we can compute the minimum and maximum as well as the 1/3 and 2/3 percentiles of the hindcast anomaly ensemble.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">P0</span> <span class="o">=</span> <span class="n">anom_hindcast_tp</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="s1">&#39;number&#39;</span><span class="p">,</span><span class="s1">&#39;time&#39;</span><span class="p">])</span>
<span class="n">P33</span> <span class="o">=</span> <span class="n">anom_hindcast_tp</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mf">3.</span><span class="p">,[</span><span class="s1">&#39;number&#39;</span><span class="p">,</span><span class="s1">&#39;time&#39;</span><span class="p">])</span>
<span class="n">P66</span> <span class="o">=</span> <span class="n">anom_hindcast_tp</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mi">2</span><span class="o">/</span><span class="mf">3.</span><span class="p">,[</span><span class="s1">&#39;number&#39;</span><span class="p">,</span><span class="s1">&#39;time&#39;</span><span class="p">])</span>
<span class="n">P100</span> <span class="o">=</span> <span class="n">anom_hindcast_tp</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="s1">&#39;number&#39;</span><span class="p">,</span><span class="s1">&#39;time&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<p>A last step before we visualise this data is to</p>
<p>The last step is to visualize the hindcast climatology boundaries as filled area and the ensemble seasonal forecast anomalies for each forecast month. The visualisation code below has three main sections:</p>
<blockquote>
<div><ol class="simple">
<li><p><strong>Initiate the figure</strong>: Initiate a matplotlib figure <br></p></li>
<li><p><strong>Plot the seasonal forecast anomalies + climatology boundaries</strong>: Plot the ensemble seasonal forecast anomalies as black circles and the hindcast climatology as filled areas <br></p></li>
<li><p><strong>Customise plot settings</strong>: Add additonal features, such as title, x- and y-axis labels etc. <br></p></li>
</ol>
</div></blockquote>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Initiate the figure</span>
<span class="n">fig</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">ax</span><span class="o">=</span><span class="n">fig</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>

<span class="c1"># Plot the seasonal forecast anomalies + climatology boundaries as filled areas</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">anoms_SAsia_m_yr</span><span class="o">.</span><span class="n">valid_time</span><span class="p">,</span> <span class="n">anoms_SAsia_m_yr</span><span class="o">.</span><span class="n">anomaly</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Forecast&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">anoms_SAsia_m_yr</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">P66</span><span class="p">,</span><span class="n">P100</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;#5ab4ac&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Above normal&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">anoms_SAsia_m_yr</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">P33</span><span class="p">,</span><span class="n">P66</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightgray&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Near average&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">anoms_SAsia_m_yr</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">P0</span><span class="p">,</span><span class="n">P33</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;#d8b365&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Below normal&#39;</span><span class="p">)</span>

<span class="c1"># Customize plot settings</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;C3S ECMWF SEAS5 total precipitation anomaly (South Asia)&#39;</span> 
          <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">linesep</span> <span class="o">+</span> 
          <span class="s1">&#39;Start date: May 2021 - Reference period: 1993-2016&#39;</span> 
          <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>

<span class="n">handles</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>
<span class="n">by_label</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">handles</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">by_label</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">by_label</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Total precipitation anomaly (mm)&#39;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">linesep</span> <span class="o">+</span> <span class="s1">&#39;Valid date&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

<span class="c1"># Save the figure</span>
<span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;./TotalPrecForecastHindcastAnomaliesSAsia.png&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<br></div>
</div>
</div>
<div class="section" id="calculate-seasonal-forecast-3-month-anomalies">
<h2>5. Calculate seasonal forecast 3-month anomalies<a class="headerlink" href="#calculate-seasonal-forecast-3-month-anomalies" title="Permalink to this headline">¶</a></h2>
<p>In this last section of the tutorial we will show how to create plots similar to those on the <a class="reference external" href="https://climate.copernicus.eu/charts/c3s_seasonal/">Copernicus Climate Change Service (C3S) website</a>. This process includes calculating 3-month aggregations and ensemble means. This differs from the previous sections where we have focussed on the processing of monthly data and individual members.</p>
<div class="section" id="compute-3-month-rolling-averages">
<h3>Compute 3-month rolling averages<a class="headerlink" href="#compute-3-month-rolling-averages" title="Permalink to this headline">¶</a></h3>
<p>The first step is to compute 3-month rolling averaged for the seasonal forecasts and hindcast data. We will do this through a combination of the xarray functions <code class="docutils literal notranslate"><span class="pre">rolling()</span></code> and <code class="docutils literal notranslate"><span class="pre">mean()</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">seas5_forecast_3m</span> <span class="o">=</span> <span class="n">seas5_forecast</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">forecastMonth</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">ds_hindcast_3m</span> <span class="o">=</span> <span class="n">ds_hindcast</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">forecastMonth</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="calculate-anomalies">
<h3>Calculate anomalies<a class="headerlink" href="#calculate-anomalies" title="Permalink to this headline">¶</a></h3>
<p>We now repeat the process of calculating anomalies with respect to the climatology, this time for the 3-monthly data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ds_hindcast_3m_hindcast_mean</span> <span class="o">=</span> <span class="n">ds_hindcast_3m</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="s1">&#39;number&#39;</span><span class="p">,</span><span class="s1">&#39;time&#39;</span><span class="p">])</span>
<span class="n">seas5_anomalies_3m_202105</span> <span class="o">=</span> <span class="n">seas5_forecast_3m</span><span class="o">.</span><span class="n">tprate</span> <span class="o">-</span> <span class="n">ds_hindcast_3m_hindcast_mean</span><span class="o">.</span><span class="n">tprate</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="ensemble-mean-anomaly">
<h3>Ensemble mean anomaly<a class="headerlink" href="#ensemble-mean-anomaly" title="Permalink to this headline">¶</a></h3>
<p>We want to compute the average of the 3-month seasonal forecast anomaly of the ensemble members. For this, we have to average over the dimension <code class="docutils literal notranslate"><span class="pre">number</span></code>. The final array has three dimensions, <code class="docutils literal notranslate"><span class="pre">forecastMonth</span></code>, <code class="docutils literal notranslate"><span class="pre">latitude</span></code> and <code class="docutils literal notranslate"><span class="pre">longitude</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">seas5_anomalies_3m_202105_em</span> <span class="o">=</span> <span class="n">seas5_anomalies_3m_202105</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s1">&#39;number&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="convert-precipitation-rate-to-accumulation-in-mm">
<h3>Convert precipitation rate to accumulation in mm<a class="headerlink" href="#convert-precipitation-rate-to-accumulation-in-mm" title="Permalink to this headline">¶</a></h3>
<p>The last step before visualizing the 3-month seasonal forecast anomalies is again to convert the precipitation accumulations to total precipitation in mm. We repeat the same steps as previously:</p>
<blockquote>
<div><ol class="simple">
<li><p><strong>Calculate number of days for each forecast month and add it as coordinate info</strong> <br></p></li>
<li><p><strong>Name the 3-month rolling archives to indicate over which months the average was built</strong> <br></p></li>
<li><p><strong>Convert the precipitation accumulations based on the number of days</strong> <br></p></li>
<li><p><strong>Add updated attributes to the data array</strong> <br></p></li>
</ol>
</div></blockquote>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Calculate number of days for each forecast month and add it as coordinate information to the data array</span>
<span class="n">vt</span> <span class="o">=</span> <span class="p">[</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">seas5_anomalies_3m_202105_em</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">+</span> <span class="n">relativedelta</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="n">fcmonth</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">fcmonth</span> <span class="ow">in</span> <span class="n">seas5_anomalies_3m_202105_em</span><span class="o">.</span><span class="n">forecastMonth</span><span class="p">]</span>
<span class="n">vts</span> <span class="o">=</span> <span class="p">[[</span><span class="n">thisvt</span><span class="o">+</span><span class="n">relativedelta</span><span class="p">(</span><span class="n">months</span><span class="o">=-</span><span class="n">mm</span><span class="p">)</span> <span class="k">for</span> <span class="n">mm</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span> <span class="k">for</span> <span class="n">thisvt</span> <span class="ow">in</span> <span class="n">vt</span><span class="p">]</span>
<span class="n">numdays</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">monthrange</span><span class="p">(</span><span class="n">dd</span><span class="o">.</span><span class="n">year</span><span class="p">,</span><span class="n">dd</span><span class="o">.</span><span class="n">month</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="n">d3</span><span class="p">])</span> <span class="k">for</span> <span class="n">d3</span> <span class="ow">in</span> <span class="n">vts</span><span class="p">]</span>
<span class="n">seas5_anomalies_3m_202105_em</span> <span class="o">=</span> <span class="n">seas5_anomalies_3m_202105_em</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">numdays</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;forecastMonth&#39;</span><span class="p">,</span><span class="n">numdays</span><span class="p">))</span>

<span class="c1"># Define names for the 3-month rolling archives, that give an indication over which months the average was built</span>
<span class="n">vts_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">{}{}{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d3</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%b&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span><span class="n">d3</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%b&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span><span class="n">d3</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%b&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">d3</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y&#39;</span><span class="p">))</span>  <span class="k">for</span> <span class="n">d3</span> <span class="ow">in</span> <span class="n">vts</span><span class="p">]</span>
<span class="n">seas5_anomalies_3m_202105_em</span> <span class="o">=</span> <span class="n">seas5_anomalies_3m_202105_em</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">valid_time</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;forecastMonth&#39;</span><span class="p">,</span><span class="n">vts_names</span><span class="p">))</span>
<span class="n">seas5_anomalies_3m_202105_em</span>

<span class="c1"># Convert the precipitation accumulations based on the number of days</span>
<span class="n">seas5_anomalies_3m_202105_em_tp</span> <span class="o">=</span> <span class="n">seas5_anomalies_3m_202105_em</span> <span class="o">*</span> <span class="n">seas5_anomalies_3m_202105_em</span><span class="o">.</span><span class="n">numdays</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">1000</span>

<span class="c1"># Add updated attributes</span>
<span class="n">seas5_anomalies_3m_202105_em_tp</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;mm&#39;</span>
<span class="n">seas5_anomalies_3m_202105_em_tp</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;SEAS5 3-monthly total precipitation ensemble mean anomaly for 6 lead-time months, start date in May 2021.&#39;</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="visualise-3-monthly-total-precipitation-ensemble-mean-anomalies">
<h3>Visualise 3-monthly total precipitation ensemble mean anomalies<a class="headerlink" href="#visualise-3-monthly-total-precipitation-ensemble-mean-anomalies" title="Permalink to this headline">¶</a></h3>
<p>Let us now visualise the 3-month total precipitation ensemble mean anomaly in an interactive plot. Widgets (<code class="docutils literal notranslate"><span class="pre">ipywidgets</span></code>) allow us to add interactive features to Jupyter notebooks. We will use these to add a dropdown menu that offers the option to choose the 3-monthly periods over which the anomalies are averaged. Given that we have 6 lead-time months, we end up with only 4 possible 3-monthly periods (the last 2 months are insufficient to create a complete 3-month aggregation).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">vts_names</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dropdown_opts</span> <span class="o">=</span> <span class="p">[(</span><span class="n">vts_names</span><span class="p">[</span><span class="n">mm</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">mm</span><span class="p">)</span> <span class="k">for</span> <span class="n">mm</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">7</span><span class="p">)]</span>
<span class="n">dropdown_opts</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tp_colors</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">153</span><span class="o">/</span><span class="mf">255.</span><span class="p">,</span><span class="mi">51</span><span class="o">/</span><span class="mf">255.</span><span class="p">,</span><span class="mi">0</span><span class="p">),(</span><span class="mi">204</span><span class="o">/</span><span class="mf">255.</span><span class="p">,</span><span class="mi">136</span><span class="o">/</span><span class="mf">255.</span><span class="p">,</span><span class="mi">0</span><span class="p">),(</span><span class="mi">1</span><span class="p">,</span><span class="mi">213</span><span class="o">/</span><span class="mf">255.</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span>
             <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">238</span><span class="o">/</span><span class="mf">255.</span><span class="p">,</span><span class="mi">153</span><span class="o">/</span><span class="mf">255.</span><span class="p">),(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),(</span><span class="mi">204</span><span class="o">/</span><span class="mf">255.</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">102</span><span class="o">/</span><span class="mf">255.</span><span class="p">),</span>
             <span class="p">(</span><span class="mi">42</span><span class="o">/</span><span class="mf">255.</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">),(</span><span class="mi">0</span><span class="p">,</span><span class="mi">153</span><span class="o">/</span><span class="mf">255.</span><span class="p">,</span><span class="mi">51</span><span class="o">/</span><span class="mf">255.</span><span class="p">),(</span><span class="mi">0</span><span class="p">,</span><span class="mi">102</span><span class="o">/</span><span class="mf">255.</span><span class="p">,</span><span class="mi">102</span><span class="o">/</span><span class="mf">255.</span><span class="p">)]</span>  
<span class="n">tp_levels</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">200</span><span class="p">,</span><span class="o">-</span><span class="mi">100</span><span class="p">,</span><span class="o">-</span><span class="mi">50</span><span class="p">,</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">50</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mi">200</span><span class="p">]</span>



<span class="k">def</span> <span class="nf">plot_leadt</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">leadt_end</span><span class="p">):</span>
    <span class="n">array</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">forecastMonth</span><span class="o">=</span><span class="n">leadt_end</span><span class="p">)</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="n">subplot_kw</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;projection&#39;</span><span class="p">:</span> <span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">()})</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">array</span><span class="o">.</span><span class="n">longitude</span><span class="p">,</span> <span class="n">array</span><span class="o">.</span><span class="n">latitude</span><span class="p">,</span> <span class="n">array</span><span class="p">,</span> 
                      <span class="n">levels</span><span class="o">=</span><span class="n">tp_levels</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="n">tp_colors</span><span class="p">,</span> <span class="n">extend</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">array</span><span class="o">.</span><span class="n">long_name</span><span class="si">}</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">linesep</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">array</span><span class="o">.</span><span class="n">valid_time</span><span class="o">.</span><span class="n">values</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">gridlines</span><span class="p">(</span><span class="n">draw_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span> 
    <span class="n">ax</span><span class="o">.</span><span class="n">coastlines</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
    <span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">fraction</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.04</span><span class="p">)</span>
    <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="n">array</span><span class="o">.</span><span class="n">units</span><span class="p">)</span>
    
    <span class="k">return</span>
    
<span class="n">dropdown_opts</span> <span class="o">=</span> <span class="p">[(</span><span class="n">vts_names</span><span class="p">[</span><span class="n">mm</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">mm</span><span class="p">)</span> <span class="k">for</span> <span class="n">mm</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">7</span><span class="p">)]</span> 
<span class="n">a</span><span class="o">=</span><span class="n">widgets</span><span class="o">.</span><span class="n">interact</span><span class="p">(</span><span class="n">plot_leadt</span><span class="p">,</span> <span class="n">ds</span><span class="o">=</span><span class="n">widgets</span><span class="o">.</span><span class="n">fixed</span><span class="p">(</span><span class="n">seas5_anomalies_3m_202105_em_tp</span><span class="p">),</span> 
                   <span class="n">leadt_end</span><span class="o">=</span><span class="n">widgets</span><span class="o">.</span><span class="n">Dropdown</span><span class="p">(</span><span class="n">options</span><span class="o">=</span><span class="n">dropdown_opts</span><span class="p">,</span><span class="n">description</span><span class="o">=</span><span class="s1">&#39;Valid Time:&#39;</span><span class="p">,</span> 
                                              <span class="n">style</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;description_width&#39;</span><span class="p">:</span> <span class="s1">&#39;initial&#39;</span><span class="p">}))</span>
</pre></div>
</div>
</div>
</div>
<div class="alert alert-block alert-success">
<b>NOTE</b>: <br>
    The plots shown here are similar but not identical to those on the <a href="https://climate.copernicus.eu/charts/c3s_seasonal/">Copernicus Climate Change Service (C3S) website</a>, specifically <a href="https://climate.copernicus.eu/charts/c3s_seasonal/c3s_seasonal_spatial_ecmf_rain_3m?facets=Parameters,precipitation%3BCentres,ECMWF&time=2021050100,744,2021060100&type=ensm&area=area08">here</a>. These plots are not identical however. The white areas in both plots, for example, have different meanings: those on the C3S website have a significance test to white-out non statistically-significant anomalies.</div><hr><p></p>
<span style='float:right'><p style=\"text-align:right;\">This project is licensed under <a href="./LICENSE">APACHE License 2.0</a>. | <a href=\"https://github.com/ecmwf-projects/copernicus-training">View on GitHub</a></span></div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            
                <!-- Previous / next buttons -->
<div class='prev-next-area'> 
    <a class='left-prev' id="prev-link" href="05_Climate_Projections_CORDEX.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Analysis of Projected versus Historical Climatology with CORDEX Data</p>
        </div>
    </a>
</div>
            
        </div>
    </div>
    <footer class="footer">
  <p>
    
      By the Copernicus Climate Change Service (C3S), entrusted to ECMWF (European Centre for Medium-Range Weather Forecasts)<br/>
    
        &copy; Copyright 2021.<br/>
  </p>
</footer>
</main>


      </div>
    </div>
  
  <script src="_static/js/index.be7d3bbb2ef33a8344ce.js"></script>

  </body>
</html>